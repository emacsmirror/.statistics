#+SETUPFILE: .orgconfig
#+NAME: setup
#+BEGIN_SRC emacs-lisp :results silent
  (require 'epkg)

  (defun emir--format-license-table (table)
    (--when-let (assoc "failure" table)
      (setcar it  "((failure))"))
    (--when-let (assoc "pending" table)
      (setcar it  "((pending))"))
    (--when-let (assoc "none" table)
      (setcar it  "((none))"))
    (--when-let (assoc "custom" table)
      (setcar it  "((custom))"))
    (let ((total (apply '+ (mapcar 'cadr table)))
          (gnu   (apply '+ (mapcar (pcase-lambda (`(,license ,count))
                                     (if (and license
                                              (string-match-p "GPL" license))
                                         count
                                       0))
                                   table))))
        (cl-flet ((percent (n) (round (* (/ n total 1.0) 100))))
          `(("License" "Count" "Percent")
            hline ,@(mapcar (pcase-lambda (`(,license ,count))
                              (list license count (percent count)))
                            table)
            hline ("total GNU" ,gnu ,(percent gnu))
            hline ("total" ,total 100)))))

  (defun emir--insert-melpa-packages-using-licenses (&rest licenses)
    (epkg-with-org-header ("Package" "License" "Class" "Link")
      (epkg-sql [:select :distinct
                 [packages:name packages:license packages:class packages:repopage]
                 :from [packages melpa-recipes]
                 :where (= packages:name melpa-recipes:epkg-package)
                 :and license :in $v1
                 :group-by packages:repopage
                 :order-by [(asc packages:name)]]
                (apply #'vector licenses))))

  (defun emir--insert-mirror-packages-using-licenses (&rest licenses)
    (epkg-with-org-header ("Package" "License" "Class" "M" "Link")
      (mapcar (pcase-lambda (`(,name ,license ,class ,repopage))
                (list name license class
                      (if (melpa-get name) t "")
                      (and (not (eq class 'wiki)) repopage)))
              (epkg-sql [:select [name license class repopage] :from packages
                         :where license :in $v1
                         :and (not (= class 'shelved))
                         :order-by [(asc name)]]
                        (apply #'vector licenses)
                        [shelved]))))
#+END_SRC
[[https://emacsmirror.net/stats][up]]

* Licenses used by packages on Melpa
** Overview
#+BEGIN_SRC emacs-lisp
  (emir--format-license-table
   (epkg-sql [:select :distinct [packages:license (funcall count *)] :as count
              :from [packages melpa-recipes]
              :where (= packages:name melpa-recipes:epkg-package)
              :group-by packages:license
              :order-by [(desc count) (asc license)]]))
#+END_SRC
#+RESULTS:
| License       | Count | Percent |
|---------------+-------+---------|
| GPL-3+        |  2534 |      68 |
| GPL-2+        |   526 |      14 |
| MIT           |   136 |       4 |
| GPL-3         |   134 |       4 |
| MIT (x11)     |   132 |       4 |
| BSD-2-clause  |    71 |       2 |
| BSD-3-clause  |    41 |       1 |
| Apache-2.0    |    37 |       1 |
| unlicense     |    32 |       1 |
| public-domain |    26 |       1 |
| as-is         |    23 |       1 |
| WTFPL         |    13 |       0 |
| GPL-1+        |     6 |       0 |
| LGPL-3+       |     4 |       0 |
| WTFPL-2       |     4 |       0 |
| AGPL-3+       |     3 |       0 |
| Artistic-2.0  |     3 |       0 |
| BEER-WARE     |     3 |       0 |
| ISC (and)     |     3 |       0 |
| CeCILL-B      |     2 |       0 |
| ISC (and/or)  |     2 |       0 |
| LGPL          |     2 |       0 |
| LGPL-2.1      |     2 |       0 |
| CC0 1.0       |     1 |       0 |
| COPYLOVE      |     1 |       0 |
| GPL           |     1 |       0 |
| LGPL-3        |     1 |       0 |
| LGPL-3.0      |     1 |       0 |
| MPL-2         |     1 |       0 |
| UIUC          |     1 |       0 |
| ((pending))   |     1 |       0 |
| zlib License  |     1 |       0 |
|---------------+-------+---------|
| total GNU     |  3214 |      86 |
|---------------+-------+---------|
| total         |  3748 |     100 |

** Issues
#+BEGIN_SRC emacs-lisp
  (emir--insert-melpa-packages-using-licenses
    "GPL" "GPL-2" "failure" "pending")
#+END_SRC
#+RESULTS:
| Package (2) | License | Class   | Link                                     |
|-------------+---------+---------+------------------------------------------|
| redshank    | GPL     | shelved |                                          |
| rubik       | pending | github  | https://github.com/Kurvivor19/rubik-mode |

** Removed packages
#+BEGIN_SRC emacs-lisp
  (let ((removed
         '(;; [[orgit-rev:~/git/emacs/melpa/::7aa634e8]]
           "smali-mode"
           ;; [[orgit-rev:~/git/emacs/melpa/::cf92ce1a]]
           "achievements"
           "avk-emacs-themes"
           "bpr"
           "coq-commenter"
           "crab"
           "darkane-theme"
           "easy-after-load"
           "edit-at-point"
           "el-pocket"
           "eno"
           "ess-R-object-popup"
           "euslisp-mode"
           "firebelly-theme"
           "flappymacs"
           "flycheck-scala-sbt"
           "gap-mode"
           "ghost-blog"
           "hlint-refactor"
           "ids-edit"
           "imgix"
           "inf-php"
           "inform7-mode"
           "ivariants"
           "ivs-edit"
           "jaunte"
           "mandoku-tls"
           "memento"
           "monochrome-theme"
           "n3-mode"
           "niflheim-theme"
           "nnir-est"
           "nyan-prompt"
           "org-jekyll"
           "ox-pandoc"
           "psc-ide"
           "sicp"
           "yatex"
           "zerodark-theme"
           ;; [[orgit-rev:~/git/emacs/melpa/::c3366117]]
           "crontab-mode"
           "harvest"
           "helm-ctest"
           "inline-crypt"
           "plantuml-mode"
           "pushover"
           "py-gnitset"
           "pyim-greatdict"
           "railgun"
           "rails-new"
           "refheap"
           "ruby-dev"
           "ruby-guard"
           "sly-repl-ansi-color"
           "smartwin"
           "sourcetalk"
           "stgit"
           "subshell-proc"
           "sudden-death"
           "syslog-mode"
           "tj-mode"
           "tronesque-theme"
           "turkish"
           "uzumaki"
           "vimgolf"
           "wordsmith-mode"
           "xah-css-mode"
           "xah-elisp-mode"
           "xah-find"
           "xah-fly-keys"
           "xah-get-thing"
           "xah-lookup"
           "xah-math-input"
           "xah-reformat-code"
           "xah-replace-pairs"
           "xahk-mode"
           "zig-mode"
           ;; [[orgit-log:~/git/emacs/melpa/::master]]
           "slime-ritz"
           ;; [[orgit-rev:~/git/emacs/melpa/::b20f5126]]
           "lively"
           ;; [[orgit-rev:~/git/emacs/melpa/::e5476274]]
           "slime-annot"
           )))
    (epkg-with-org-header ("Package" "R" "License" "Class" "Link")
      (--keep (-when-let (pkg (epkg it))
                (let ((rcp (melpa-get it)))
                  (and (not rcp)
                       (list it
                             (if rcp "t" "")
                             (oref pkg license)
                             (substring (symbol-name (class-of pkg)) 5 -8)
                             (oref pkg repopage)))))
              removed)))
#+END_SRC
#+RESULTS:
| Package (26)       | R | License         | Class   | Link                                              |
|--------------------+---+-----------------+---------+---------------------------------------------------|
| crab               |   | pending         | shelved | https://github.com/puffnfresh/crab-emacs          |
| ess-R-object-popup |   | pending         | shelved | https://github.com/myuhe/ess-R-object-popup.el    |
| flycheck-scala-sbt |   | public-domain   | shelved | https://github.com/rjmac/flycheck-scala-sbt       |
| imgix              |   | pending         | shelved | https://github.com/imgix/imgix-emacs              |
| inf-php            |   | pending         | shelved | https://github.com/taksatou/inf-php               |
| inform7-mode       |   | pending         | shelved | https://github.com/fred-o/inform7-mode            |
| jaunte             |   | pending         | shelved | https://github.com/kawaguchi/jaunte.el            |
| memento            |   | pending         | shelved | https://github.com/ehartc/memento                 |
| n3-mode            |   | pending         | shelved | https://github.com/doriantaylor/n3-mode-for-emacs |
| nyan-prompt        |   | COPYLOVE        | github  | https://github.com/PuercoPop/nyan-prompt          |
| org-jekyll         |   | pending         | shelved | https://github.com/juanre/org-jekyll              |
| crontab-mode       |   | GPL-2           | shelved | https://github.com/emacsorphanage/crontab-mode    |
| pyim-greatdict     |   | pending         | shelved | https://github.com/tumashu/pyim-greatdict         |
| railgun            |   | pending         | shelved | https://github.com/mbriggs/railgun.el             |
| rails-new          |   | pending         | shelved | https://github.com/cheunghy/rails-new             |
| refheap            |   | none            | shelved | https://github.com/Raynes/refheap.el              |
| ruby-dev           |   | pending         | shelved | https://github.com/Mon-Ouie/ruby-dev.el           |
| ruby-guard         |   | pending         | shelved | https://github.com/cheunghy/ruby-guard            |
| smartwin           |   | GPL-2           | github  | https://github.com/jerryxgh/smartwin              |
| sourcetalk         |   | pending         | shelved | https://github.com/malroc/sourcetalk_emacs        |
| subshell-proc      |   | pending         | shelved | https://github.com/andrewmains12/subshell-proc    |
| syslog-mode        |   | GPL-2           | github  | https://github.com/vapniks/syslog-mode            |
| tj-mode            |   | pending         | shelved | https://github.com/katspaugh/tj-mode              |
| uzumaki            |   | pending         | shelved | https://github.com/geyslan/uzumaki                |
| vimgolf            |   | CC BY-NC-SA 3.0 | github  | https://github.com/timvisher/vimgolf.el           |
| slime-ritz         |   | EPL             | shelved |                                                   |

* Licenses used by packages on the Emacsmirror
** Overview
#+BEGIN_SRC emacs-lisp
  (emir--format-license-table
   (epkg-sql [:select [license (funcall count *)] :as count
              :from packages
              :where (and (not (= class 'builtin))
                          (not (= class 'shelved)))
              :group-by license
              :order-by [(desc count) (asc license)]]))
#+END_SRC
#+RESULTS:
| License         | Count | Percent |
|-----------------+-------+---------|
| GPL-3+          |  3170 |      60 |
| GPL-2+          |  1333 |      25 |
| GPL-3           |   142 |       3 |
| MIT             |   139 |       3 |
| MIT (x11)       |   131 |       2 |
| BSD-2-clause    |    75 |       1 |
| public-domain   |    49 |       1 |
| BSD-3-clause    |    45 |       1 |
| Apache-2.0      |    35 |       1 |
| unlicense       |    34 |       1 |
| WTFPL           |    32 |       1 |
| as-is           |    31 |       1 |
| GPL-1+          |     8 |       0 |
| LGPL-3+         |     5 |       0 |
| WTFPL-2         |     5 |       0 |
| AGPL-3+         |     3 |       0 |
| Artistic-2.0    |     3 |       0 |
| GPL-2           |     3 |       0 |
| ISC (and)       |     3 |       0 |
| MS-PL           |     3 |       0 |
| COPYLOVE        |     2 |       0 |
| CeCILL-B        |     2 |       0 |
| ISC (and/or)    |     2 |       0 |
| LGPL-2.1        |     2 |       0 |
| BEER-WARE       |     1 |       0 |
| CC BY-NC-SA 3.0 |     1 |       0 |
| CC0 1.0         |     1 |       0 |
| GPL             |     1 |       0 |
| LGPL            |     1 |       0 |
| LGPL-3          |     1 |       0 |
| LGPL-3.0        |     1 |       0 |
| MPL-2           |     1 |       0 |
| Ruby            |     1 |       0 |
| UIUC            |     1 |       0 |
| ((pending))     |     1 |       0 |
| zlib License    |     1 |       0 |
|-----------------+-------+---------|
| total GNU       |  4670 |      89 |
|-----------------+-------+---------|
| total           |  5269 |     100 |

** Issues
#+BEGIN_SRC emacs-lisp
  (emir--insert-mirror-packages-using-licenses
    "GPL" "GPL-2" "failure" "pending" nil)
#+END_SRC
#+RESULTS:
| Package (5)    | License | Class  | M | Link                                       |
|----------------+---------+--------+---+--------------------------------------------|
| coq            | GPL     | github |   | https://github.com/ProofGeneral/PG         |
| gnus-autocheck | GPL-2   | github |   | https://github.com/slaanesh/gnus-autocheck |
| rubik          | pending | github | t | https://github.com/Kurvivor19/rubik-mode   |
| smartwin       | GPL-2   | github |   | https://github.com/jerryxgh/smartwin       |
| syslog-mode    | GPL-2   | github |   | https://github.com/vapniks/syslog-mode     |

- coq [[https://github.com/ProofGeneral/PG/issues/198][#198]]
- gnus-autocheck [[https://github.com/slaanesh/gnus-autocheck/issues/2][#2]]
- smartwin [[https://github.com/jerryxgh/smartwin/issues/3][#3]]
- syslog-mode [[https://github.com/vapniks/syslog-mode/issues/15][#15]]

